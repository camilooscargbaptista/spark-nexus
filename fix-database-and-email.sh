#!/bin/bash

# ================================================
# Script de Corre√ß√£o: Databases + Email HostGator
# Spark Nexus - Configura√ß√£o Completa
# ================================================

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}================================================${NC}"
echo -e "${CYAN}üîß Corre√ß√£o de Databases + Config HostGator${NC}"
echo -e "${CYAN}================================================${NC}"

# ================================================
# PARTE 1: CORRIGIR DATABASES
# ================================================
echo -e "\n${BLUE}[PARTE 1] Corrigindo Databases${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# Verificar se PostgreSQL est√° rodando
if ! docker exec sparknexus-postgres pg_isready -U sparknexus > /dev/null 2>&1; then
    echo -e "${RED}‚ùå PostgreSQL n√£o est√° rodando. Iniciando...${NC}"
    docker-compose up -d postgres
    sleep 5
fi

echo -e "${YELLOW}üîç Verificando databases existentes...${NC}"
EXISTING_DBS=$(docker exec sparknexus-postgres psql -U sparknexus -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" 2>/dev/null | sed 's/^[ \t]*//;s/[ \t]*$//')

echo -e "${CYAN}Databases encontrados:${NC}"
echo "$EXISTING_DBS" | while read -r db; do
    if [ ! -z "$db" ]; then
        echo -e "  ‚úÖ $db"
    fi
done

# Criar databases faltantes
echo -e "\n${YELLOW}üîß Criando databases faltantes...${NC}"

# Lista de databases necess√°rios
REQUIRED_DBS=(
    "sparknexus"
    "sparknexus_core"
    "sparknexus_tenants"
    "sparknexus_modules"
    "n8n"
)

for DB_NAME in "${REQUIRED_DBS[@]}"; do
    echo -n "Verificando database $DB_NAME... "
    
    if docker exec sparknexus-postgres psql -U sparknexus -lqt | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
        echo -e "${GREEN}j√° existe ‚úÖ${NC}"
    else
        echo -e "${YELLOW}criando...${NC}"
        docker exec sparknexus-postgres psql -U sparknexus -c "CREATE DATABASE $DB_NAME;" 2>/dev/null || {
            echo -e "${YELLOW}  ‚ö†Ô∏è Database pode j√° existir ou houve um warning${NC}"
        }
        
        # Dar permiss√µes
        docker exec sparknexus-postgres psql -U sparknexus -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO sparknexus;" 2>/dev/null || true
    fi
done

# Criar schemas necess√°rios
echo -e "\n${YELLOW}üìã Criando schemas necess√°rios...${NC}"

# Schema para sparknexus_core
docker exec -i sparknexus-postgres psql -U sparknexus -d sparknexus_core << 'SQL' 2>/dev/null || true
-- Criar schema auth se n√£o existir
CREATE SCHEMA IF NOT EXISTS auth;
CREATE SCHEMA IF NOT EXISTS public;

-- Tabela de usu√°rios b√°sica
CREATE TABLE IF NOT EXISTS auth.users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de sess√µes
CREATE TABLE IF NOT EXISTS auth.sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES auth.users(id),
    token VARCHAR(500) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP
);
SQL

echo -e "${GREEN}‚úÖ Schema auth criado/atualizado${NC}"

# Schema para sparknexus_tenants
docker exec -i sparknexus-postgres psql -U sparknexus -d sparknexus_tenants << 'SQL' 2>/dev/null || true
-- Criar schema tenant
CREATE SCHEMA IF NOT EXISTS tenant;

-- Tabela de organiza√ß√µes
CREATE TABLE IF NOT EXISTS tenant.organizations (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    plan VARCHAR(50) DEFAULT 'free',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de membros
CREATE TABLE IF NOT EXISTS tenant.organization_members (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER,
    user_id INTEGER,
    role VARCHAR(50) DEFAULT 'member',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
SQL

echo -e "${GREEN}‚úÖ Schema tenant criado/atualizado${NC}"

# Schema para sparknexus_modules
docker exec -i sparknexus-postgres psql -U sparknexus -d sparknexus_modules << 'SQL' 2>/dev/null || true
-- Criar schema modules
CREATE SCHEMA IF NOT EXISTS modules;

-- Tabela de m√≥dulos instalados
CREATE TABLE IF NOT EXISTS modules.installed (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    version VARCHAR(20),
    active BOOLEAN DEFAULT true,
    installed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Inserir m√≥dulos padr√£o
INSERT INTO modules.installed (name, version) VALUES
    ('email-validator', '1.0.0'),
    ('client-dashboard', '1.0.0'),
    ('auth-service', '1.0.0')
ON CONFLICT (name) DO NOTHING;
SQL

echo -e "${GREEN}‚úÖ Schema modules criado/atualizado${NC}"

echo -e "\n${GREEN}‚úÖ TODOS OS DATABASES CORRIGIDOS!${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# ================================================
# PARTE 2: CONFIGURAR EMAIL HOSTGATOR
# ================================================
echo -e "\n${BLUE}[PARTE 2] Configurando Email HostGator${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# Fazer backup do .env atual
cp .env .env.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

echo -e "${CYAN}üìß Configura√ß√£o do HostGator Email${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}Informa√ß√µes necess√°rias do seu HostGator:${NC}"
echo ""
echo -e "${CYAN}1. SERVIDOR SMTP:${NC}"
echo "   Se seu dom√≠nio √© sparknexus.com.br:"
echo "   ‚Ä¢ Servidor: mail.sparknexus.com.br"
echo "   ‚Ä¢ Porta: 465 (SSL) ou 587 (TLS)"
echo ""
echo -e "${CYAN}2. CREDENCIAIS:${NC}"
echo "   ‚Ä¢ Email completo: contato@sparknexus.com.br"
echo "   ‚Ä¢ Senha: Joao@26082310"
echo ""

# Solicitar informa√ß√µes do usu√°rio
echo -e "${YELLOW}Por favor, forne√ßa as informa√ß√µes:${NC}"
echo ""

read -p "Digite seu email completo do HostGator (ex: contato@sparknexus.com.br): " HOSTGATOR_EMAIL
read -p "Digite o servidor SMTP (ex: mail.sparknexus.com.br): " HOSTGATOR_SMTP
read -p "Digite a porta SMTP (465 para SSL ou 587 para TLS): " HOSTGATOR_PORT
read -s -p "Digite sua senha do email: " HOSTGATOR_PASSWORD
echo ""

# Determinar o tipo de criptografia baseado na porta
if [ "$HOSTGATOR_PORT" == "465" ]; then
    SMTP_SECURE="ssl"
elif [ "$HOSTGATOR_PORT" == "587" ]; then
    SMTP_SECURE="tls"
else
    SMTP_SECURE="tls"
fi

# Atualizar arquivo .env
echo -e "\n${YELLOW}üìù Atualizando arquivo .env...${NC}"

# Criar arquivo .env se n√£o existir
if [ ! -f .env ]; then
    touch .env
fi

# Fun√ß√£o para atualizar ou adicionar vari√°vel no .env
update_env() {
    local key=$1
    local value=$2
    
    if grep -q "^$key=" .env; then
        # Se a chave existe, atualiza
        sed -i.bak "s|^$key=.*|$key=$value|" .env
    else
        # Se n√£o existe, adiciona
        echo "$key=$value" >> .env
    fi
}

# Atualizar vari√°veis de email
update_env "SMTP_HOST" "$HOSTGATOR_SMTP"
update_env "SMTP_PORT" "$HOSTGATOR_PORT"
update_env "SMTP_SECURE" "$SMTP_SECURE"
update_env "SMTP_USER" "$HOSTGATOR_EMAIL"
update_env "SMTP_PASS" "$HOSTGATOR_PASSWORD"
update_env "SMTP_FROM" "$HOSTGATOR_EMAIL"
update_env "EMAIL_FROM_NAME" "Spark Nexus"

echo -e "${GREEN}‚úÖ Arquivo .env atualizado com configura√ß√µes do HostGator${NC}"

# ================================================
# PARTE 3: ATUALIZAR CONFIGURA√á√ÉO DO EMAIL SERVICE
# ================================================
echo -e "\n${BLUE}[PARTE 3] Atualizando Email Service${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# Criar arquivo de configura√ß√£o do email service
cat > core/email-validator/services/emailConfig.js << 'EOF'
// Configura√ß√£o do Email Service para HostGator
const nodemailer = require('nodemailer');

class EmailService {
    constructor() {
        // Configura√ß√£o espec√≠fica para HostGator
        this.transporter = nodemailer.createTransport({
            host: process.env.SMTP_HOST,
            port: parseInt(process.env.SMTP_PORT),
            secure: process.env.SMTP_PORT === '465', // true para 465, false para outras
            auth: {
                user: process.env.SMTP_USER,
                pass: process.env.SMTP_PASS
            },
            tls: {
                rejectUnauthorized: false // Necess√°rio para alguns servidores HostGator
            },
            debug: true, // Ativar debug para troubleshooting
            logger: true // Ativar logs
        });

        // Verificar conex√£o ao inicializar
        this.verifyConnection();
    }

    async verifyConnection() {
        try {
            await this.transporter.verify();
            console.log('‚úÖ Conex√£o com servidor SMTP HostGator estabelecida');
        } catch (error) {
            console.error('‚ùå Erro ao conectar com SMTP HostGator:', error);
            console.log('Configura√ß√£o atual:');
            console.log('- Host:', process.env.SMTP_HOST);
            console.log('- Port:', process.env.SMTP_PORT);
            console.log('- User:', process.env.SMTP_USER);
        }
    }

    async sendEmail(to, subject, html, text) {
        try {
            const mailOptions = {
                from: `"${process.env.EMAIL_FROM_NAME || 'Spark Nexus'}" <${process.env.SMTP_FROM}>`,
                to: to,
                subject: subject,
                html: html,
                text: text || html.replace(/<[^>]*>/g, '')
            };

            const info = await this.transporter.sendMail(mailOptions);
            console.log('‚úÖ Email enviado:', info.messageId);
            return { success: true, messageId: info.messageId };
        } catch (error) {
            console.error('‚ùå Erro ao enviar email:', error);
            return { success: false, error: error.message };
        }
    }

    async sendValidationReport(to, results) {
        const subject = 'Relat√≥rio de Valida√ß√£o - Spark Nexus';
        const html = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #667eea;">Relat√≥rio de Valida√ß√£o Conclu√≠do</h2>
                <p>Sua valida√ß√£o de emails foi conclu√≠da com sucesso!</p>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>Resumo dos Resultados:</h3>
                    <ul>
                        <li>Total de emails: ${results.total || 0}</li>
                        <li>V√°lidos: ${results.valid || 0}</li>
                        <li>Inv√°lidos: ${results.invalid || 0}</li>
                        <li>Taxa de sucesso: ${results.successRate || 0}%</li>
                    </ul>
                </div>
                
                <p>Acesse o dashboard para ver os detalhes completos.</p>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <p style="color: #666; font-size: 12px;">
                        Spark Nexus - Sistema de Valida√ß√£o de Emails<br>
                        Este √© um email autom√°tico, n√£o responda.
                    </p>
                </div>
            </div>
        `;
        
        return await this.sendEmail(to, subject, html);
    }
}

module.exports = EmailService;
EOF

echo -e "${GREEN}‚úÖ Email Service atualizado para HostGator${NC}"

# ================================================
# PARTE 4: TESTAR CONFIGURA√á√ÉO
# ================================================
echo -e "\n${BLUE}[PARTE 4] Testando Configura√ß√£o${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# Reiniciar containers para aplicar novas configura√ß√µes
echo -e "${YELLOW}üîÑ Reiniciando servi√ßos...${NC}"
docker-compose restart email-validator
docker-compose restart client-dashboard

echo -e "${YELLOW}‚è≥ Aguardando servi√ßos reiniciarem...${NC}"
sleep 10

# Criar script de teste de email
cat > test-email-hostgator.js << 'EOF'
// Script de teste para email HostGator
require('dotenv').config();
const nodemailer = require('nodemailer');

async function testEmail() {
    console.log('üß™ Testando configura√ß√£o de email HostGator...\n');
    
    console.log('Configura√ß√£o atual:');
    console.log('- SMTP Host:', process.env.SMTP_HOST);
    console.log('- SMTP Port:', process.env.SMTP_PORT);
    console.log('- SMTP User:', process.env.SMTP_USER);
    console.log('- From:', process.env.SMTP_FROM);
    console.log('\nTentando conectar...\n');

    const transporter = nodemailer.createTransport({
        host: process.env.SMTP_HOST,
        port: parseInt(process.env.SMTP_PORT),
        secure: process.env.SMTP_PORT === '465',
        auth: {
            user: process.env.SMTP_USER,
            pass: process.env.SMTP_PASS
        },
        tls: {
            rejectUnauthorized: false
        },
        debug: true,
        logger: true
    });

    try {
        // Verificar conex√£o
        await transporter.verify();
        console.log('‚úÖ Conex√£o com HostGator SMTP estabelecida!\n');
        
        // Enviar email de teste
        console.log('üìß Enviando email de teste...\n');
        
        const info = await transporter.sendMail({
            from: `"Spark Nexus Test" <${process.env.SMTP_FROM}>`,
            to: process.env.SMTP_USER, // Envia para si mesmo
            subject: 'Teste de Configura√ß√£o - Spark Nexus',
            html: `
                <h2>‚úÖ Configura√ß√£o Bem Sucedida!</h2>
                <p>Este √© um email de teste do sistema Spark Nexus.</p>
                <p>Se voc√™ est√° recebendo este email, significa que a configura√ß√£o do HostGator est√° funcionando corretamente!</p>
                <hr>
                <p><small>Configura√ß√£o usada:<br>
                Host: ${process.env.SMTP_HOST}<br>
                Port: ${process.env.SMTP_PORT}<br>
                User: ${process.env.SMTP_USER}</small></p>
            `
        });
        
        console.log('‚úÖ Email enviado com sucesso!');
        console.log('Message ID:', info.messageId);
        console.log('\nüéâ Configura√ß√£o do HostGator funcionando perfeitamente!');
        
    } catch (error) {
        console.error('‚ùå Erro:', error.message);
        console.log('\nüîß Poss√≠veis solu√ß√µes:');
        console.log('1. Verifique se o email e senha est√£o corretos');
        console.log('2. Certifique-se de que o servidor SMTP est√° correto');
        console.log('3. Tente usar porta 587 (TLS) ou 465 (SSL)');
        console.log('4. Verifique se o email tem permiss√£o para envio SMTP');
        console.log('5. No cPanel, verifique se a autentica√ß√£o SMTP est√° habilitada');
    }
}

testEmail();
EOF

# Executar teste dentro do container
echo -e "\n${YELLOW}üß™ Executando teste de email...${NC}"
docker exec sparknexus-email-validator node -e "
const nodemailer = require('nodemailer');
(async () => {
    console.log('Testando conex√£o SMTP...');
    const transporter = nodemailer.createTransport({
        host: '$HOSTGATOR_SMTP',
        port: $HOSTGATOR_PORT,
        secure: $HOSTGATOR_PORT === 465,
        auth: {
            user: '$HOSTGATOR_EMAIL',
            pass: '$HOSTGATOR_PASSWORD'
        },
        tls: { rejectUnauthorized: false }
    });
    
    try {
        await transporter.verify();
        console.log('‚úÖ Conex√£o SMTP OK!');
    } catch (e) {
        console.log('‚ùå Erro:', e.message);
    }
})();
" 2>/dev/null || echo -e "${YELLOW}‚ö†Ô∏è Teste ser√° executado ap√≥s reiniciar os containers${NC}"

# ================================================
# RESULTADO FINAL
# ================================================
echo ""
echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}‚úÖ CONFIGURA√á√ÉO COMPLETA!${NC}"
echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
echo -e "${CYAN}üìä Status dos Databases:${NC}"
echo -e "  ‚úÖ sparknexus"
echo -e "  ‚úÖ sparknexus_core"
echo -e "  ‚úÖ sparknexus_tenants"  
echo -e "  ‚úÖ sparknexus_modules"
echo -e "  ‚úÖ n8n"
echo ""
echo -e "${CYAN}üìß Configura√ß√£o de Email HostGator:${NC}"
echo -e "  Host: $HOSTGATOR_SMTP"
echo -e "  Port: $HOSTGATOR_PORT"
echo -e "  User: $HOSTGATOR_EMAIL"
echo -e "  Security: $SMTP_SECURE"
echo ""
echo -e "${YELLOW}üîç Para verificar os logs de email:${NC}"
echo -e "  docker-compose logs -f email-validator"
echo ""
echo -e "${YELLOW}üß™ Para testar o envio de email:${NC}"
echo -e "  node test-email-hostgator.js"
echo ""
echo -e "${BLUE}üí° Dicas Importantes HostGator:${NC}"
echo -e "  1. Certifique-se de que a autentica√ß√£o SMTP est√° habilitada no cPanel"
echo -e "  2. Use a senha do EMAIL, n√£o a senha do cPanel"
echo -e "  3. Se usar porta 465, o SSL deve estar ativo"
echo -e "  4. Se usar porta 587, use TLS/STARTTLS"
echo -e "  5. Alguns planos limitam envios a 500 emails/hora"
echo ""
echo -e "${GREEN}Sistema pronto para uso com HostGator Email! üöÄ${NC}"