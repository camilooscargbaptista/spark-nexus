<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir senha - Spark Nexus</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .reset-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            width: 450px;
            max-width: 90%;
        }
        
        .reset-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 30px;
            text-align: center;
        }
        
        .reset-header h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .reset-header p {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }
        
        .reset-form {
            padding: 40px 30px;
        }
        
        .btn-reset {
            width: 100%;
            margin-top: 20px;
        }
        
        .back-link {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .back-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .token-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin: 0 5px;
        }

        .token-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .token-inputs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .password-strength-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .password-strength-bar.strength-weak {
            background: linear-gradient(to right, #f56565 30%, #e2e8f0 30%);
        }

        .password-strength-bar.strength-medium {
            background: linear-gradient(to right, #ed8936 70%, #e2e8f0 70%);
        }

        .password-strength-bar.strength-strong {
            background: #48bb78;
        }
    </style>
</head>
<body>
    <div class="reset-container">
        <div class="reset-header">
            <h1>üîê Spark Nexus</h1>
            <p>Redefinir senha</p>
        </div>
        
        <div class="reset-form">
            <div id="alertBox" class="alert"></div>
            
            <!-- Step 1: Inserir c√≥digo -->
            <div id="step1" class="step active">
                <p style="text-align: center; margin-bottom: 20px; color: #666;">
                    Digite o c√≥digo de 6 d√≠gitos enviado para seu email:
                </p>
                
                <div class="token-inputs">
                    <input type="text" class="token-input token-code" maxlength="1" pattern="[a-zA-Z0-9]">
                    <input type="text" class="token-input token-code" maxlength="1" pattern="[a-zA-Z0-9]">
                    <input type="text" class="token-input token-code" maxlength="1" pattern="[a-zA-Z0-9]">
                    <input type="text" class="token-input token-code" maxlength="1" pattern="[a-zA-Z0-9]">
                    <input type="text" class="token-input token-code" maxlength="1" pattern="[a-zA-Z0-9]">
                    <input type="text" class="token-input token-code" maxlength="1" pattern="[a-zA-Z0-9]">
                </div>
                
                <button type="button" class="btn btn-primary btn-reset" onclick="verifyToken()">
                    Verificar c√≥digo
                </button>
            </div>

            <!-- Step 2: Nova senha -->
            <div id="step2" class="step">
                <form id="resetForm">
                    <div class="form-group">
                        <label for="password">Nova senha</label>
                        <input type="password" id="password" name="password" required 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        <div id="passwordStrengthBar" class="password-strength-bar"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar nova senha</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        <span id="confirmPasswordError" class="error-text"></span>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-reset">
                        Redefinir senha
                    </button>
                </form>
            </div>
            
            <div class="back-link">
                <a href="/login">‚Üê Voltar ao login</a>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let verifiedToken = '';
        
        // Verificar se j√° est√° logado
        if (auth.isAuthenticated()) {
            window.location.href = '/';
        }

        // Verificar se tem token na URL
        const urlParams = new URLSearchParams(window.location.search);
        const tokenFromUrl = urlParams.get('token');
        if (tokenFromUrl) {
            // Preencher automaticamente o token
            const tokenInputs = document.querySelectorAll('.token-code');
            for (let i = 0; i < tokenFromUrl.length && i < 6; i++) {
                tokenInputs[i].value = tokenFromUrl[i];
            }
        }

        // Configurar inputs de token
        const tokenInputs = document.querySelectorAll('.token-code');
        tokenInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                if (value && index < tokenInputs.length - 1) {
                    tokenInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    tokenInputs[index - 1].focus();
                }
            });
        });

        // Configurar medidor de for√ßa da senha
        const passwordInput = document.getElementById('password');
        const strengthBar = document.getElementById('passwordStrengthBar');

        passwordInput?.addEventListener('input', (e) => {
            const password = e.target.value;
            const strength = calculatePasswordStrength(password);

            strengthBar.className = 'password-strength-bar';
            if (strength.score <= 2) {
                strengthBar.classList.add('strength-weak');
            } else if (strength.score <= 3) {
                strengthBar.classList.add('strength-medium');
            } else {
                strengthBar.classList.add('strength-strong');
            }
        });

        function calculatePasswordStrength(password) {
            const checks = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                numbers: /\d/.test(password),
                special: /[!@#$%^&*(),.?\":{}|<>]/.test(password)
            };

            const score = Object.values(checks).filter(Boolean).length;
            return { checks, score };
        }

        // Verificar token
        async function verifyToken() {
            const alertBox = document.getElementById('alertBox');
            const inputs = document.querySelectorAll('.token-code');
            const token = Array.from(inputs).map(i => i.value).join('');
            const verifyButton = document.querySelector('#step1 .btn-primary');

            alertBox.style.display = 'none';

            if (token.length !== 6) {
                alertBox.className = 'alert alert-error';
                alertBox.textContent = 'Digite o c√≥digo completo de 6 d√≠gitos';
                alertBox.style.display = 'block';
                return;
            }

            try {
                showLoading(verifyButton, 'Verificando...');

                const response = await fetch('/api/auth/verify-reset-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();

                if (response.ok) {
                    verifiedToken = token;
                    
                    // Avan√ßar para step 2
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    
                    alertBox.className = 'alert alert-success';
                    alertBox.textContent = 'C√≥digo verificado! Agora defina sua nova senha.';
                    alertBox.style.display = 'block';
                } else {
                    alertBox.className = 'alert alert-error';
                    alertBox.textContent = data.error || 'C√≥digo inv√°lido';
                    alertBox.style.display = 'block';
                }
            } catch (error) {
                alertBox.className = 'alert alert-error';
                alertBox.textContent = 'Erro ao verificar c√≥digo';
                alertBox.style.display = 'block';
            } finally {
                hideLoading(verifyButton);
            }
        }

        // Handle reset form
        document.getElementById('resetForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const alertBox = document.getElementById('alertBox');
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            alertBox.style.display = 'none';
            document.getElementById('confirmPasswordError').textContent = '';

            // Validar senhas
            if (password !== confirmPassword) {
                document.getElementById('confirmPasswordError').textContent = 'As senhas n√£o coincidem';
                return;
            }

            // Validar for√ßa da senha
            const strength = calculatePasswordStrength(password);
            if (strength.score < 4) {
                alertBox.className = 'alert alert-error';
                alertBox.textContent = 'Senha deve ter mai√∫sculas, min√∫sculas, n√∫meros e caracteres especiais';
                alertBox.style.display = 'block';
                return;
            }

            try {
                showLoading(submitButton, 'Redefinindo...');

                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        token: verifiedToken,
                        password: password 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alertBox.className = 'alert alert-success';
                    alertBox.textContent = 'Senha redefinida com sucesso! Redirecionando para login...';
                    alertBox.style.display = 'block';
                    
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    alertBox.className = 'alert alert-error';
                    alertBox.textContent = data.error || 'Erro ao redefinir senha';
                    alertBox.style.display = 'block';
                }
            } catch (error) {
                alertBox.className = 'alert alert-error';
                alertBox.textContent = 'Erro ao conectar com o servidor';
                alertBox.style.display = 'block';
            } finally {
                hideLoading(submitButton);
            }
        });
    </script>
</body>
</html>